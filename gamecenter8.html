<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŒå±‚æ¸¸æˆä¸­å¿ƒ</title>
    <style>
        body { background-color: #1a1a1a; color: #e0e0e0; font-family: sans-serif; overflow: hidden; margin: 0; padding: 15px; user-select: none;}
        .header { display: flex; justify-content: space-between; border-bottom: 1px solid #333; padding-bottom: 10px; margin-bottom: 10px; }
        #screen-display { background: rgba(0,0,0,0.3); border: 1px solid #333; height: 150px; overflow-y: auto; padding: 10px; border-radius: 5px; white-space: pre-wrap; font-family: monospace; }
        button { width: 100%; padding: 12px; background: #667eea; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; margin-top: 10px; }
        button:disabled { background: #444; color: #888; cursor: wait; }
        .log-p { color: #4ecdc4; }
        .log-ai { color: #ff9f43; }
        .log-sys { color: #888; font-size: 0.8em; }
    </style>
</head>
<body>
    <div class="header">
        <span>ğŸ² äº’åŠ¨æ¡Œæ¸¸</span>
        <span id="player-name" style="font-size:12px; color:#aaa;">ç©å®¶</span>
    </div>
    <div id="screen-display"></div>
    <button id="dice-btn">ğŸ² æ·éª°å­</button>

    <script>
        // å”¯ä¸€çš„ç¼“å­˜ Key
        const CACHE_KEY = 'st_game_local_cache';
        
        let gameHistory = "";
        let myName = "ç©å®¶";

        // ===============================================
        // æ ¸å¿ƒæ¸²æŸ“å‡½æ•°ï¼šåªç®¡æ˜¾ç¤ºï¼Œä¸ç®¡ç½‘ç»œ
        // ===============================================
        function render() {
            $('#screen-display').html(gameHistory.replace(/\n/g, "<br>"));
            // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
            const div = document.getElementById('screen-display');
            div.scrollTop = div.scrollHeight;
        }

        // æ·»åŠ æ—¥å¿—å¹¶ç«‹å³ä¿å­˜åˆ°æœ¬åœ°
        function addLog(name, text, css) {
            const entry = `<span class="${css}">[${name}]</span> ${text}`;
            if (gameHistory) gameHistory += "\n";
            gameHistory += newEntry;
            
            // 1. ç«‹åˆ»æ˜¾ç¤ºï¼(å‚è€ƒä»£ç å°±æ˜¯è¿™ä¹ˆåšçš„)
            render();
            
            // 2. ç«‹åˆ»å­˜æœ¬åœ°ï¼(é˜²æ­¢åˆ·æ–°ä¸¢å¤±)
            localStorage.setItem(CACHE_KEY, gameHistory);
        }

        $(document).ready(function() {
            if (typeof ST_UserName !== 'undefined') myName = ST_UserName;
            $('#player-name').text(myName);

            // ===============================================
            // åˆå§‹åŒ–æ•°æ®åŠ è½½é€»è¾‘ (æœ¬åœ°ä¼˜å…ˆ)
            // ===============================================
            const localData = localStorage.getItem(CACHE_KEY);
            
            // ä¼˜å…ˆç”¨æ­£åˆ™ä¼ è¿›æ¥çš„æ•°æ®(äº‘ç«¯)ï¼Œå¦‚æœäº‘ç«¯æ²¡æœ‰ï¼Œå°±ç”¨æœ¬åœ°çš„(å…œåº•)
            if (typeof ST_InitialData !== 'undefined' && ST_InitialData.trim() !== "") {
                gameHistory = ST_InitialData;
            } else if (localData) {
                gameHistory = localData;
            }

            if (gameHistory) {
                render();
            } else {
                addLog("ç³»ç»Ÿ", "æ¸¸æˆå‡†å¤‡å°±ç»ª...", "log-sys");
            }

            // ===============================================
            // ç‚¹å‡»äº‹ä»¶ï¼šå‚è€ƒä»£ç çš„ UI First é€»è¾‘
            // ===============================================
            $('#dice-btn').click(async function() {
                const $btn = $(this);
                $btn.prop('disabled', true).text("ç­‰å¾…å›åº”...");

                // --- æ­¥éª¤ 1: ç©å®¶è¡ŒåŠ¨ (ç«‹åˆ»ä¸Šå±) ---
                const point = Math.floor(Math.random() * 6) + 1;
                addLog(myName, `æ·å‡ºäº† ${point} ç‚¹`, "log-p");

                // --- æ­¥éª¤ 2: å°è¯•è”ç½‘ä¿å­˜ (å¼‚æ­¥ï¼Œä¸é˜»å¡ UI) ---
                // æˆ‘ä»¬ä¸ await å®ƒï¼Œè®©å®ƒåœ¨åå°è·‘ã€‚å¦‚æœ 504 äº†ä¹Ÿæ— æ‰€è°“ï¼Œåæ­£æœ¬åœ°æœ‰ç¼“å­˜
                if (window.ST_Game_API) {
                    window.ST_Game_API.save(gameHistory).catch(e => console.warn("åå°ä¿å­˜å¤±è´¥ï¼Œä½†æœ¬åœ°å·²å­˜"));
                }

                // --- æ­¥éª¤ 3: è¯·æ±‚ AI (å¸¦è¶…æ—¶ä¿æŠ¤) ---
                if (window.ST_Game_API) {
                    
                    // è®¾ç½® 15ç§’ è¶…æ—¶ï¼Œé˜²æ­¢æŒ‰é’®æ°¸è¿œå˜ç°
                    const timer = setTimeout(() => {
                        addLog("ç³»ç»Ÿ", "å¯¹æ–¹è¿æ¥è¶…æ—¶ (504)", "log-sys");
                        $btn.prop('disabled', false).text("ğŸ² æ·éª°å­");
                    }, 15000);

                    const prompt = `[æ·éª°å­æ¸¸æˆ] ç©å®¶(${myName})æ·å‡ºäº† ${point} ç‚¹ã€‚è¯·ä½ ä»¥{{char}}çš„èº«ä»½ä¹Ÿæ·ä¸€ä¸ªéª°å­ï¼Œå¹¶ç®€çŸ­è¯„ä»·ã€‚è¯·ç›´æ¥è¾“å‡ºç»“æœæ–‡æœ¬ï¼Œä¸è¦å¸¦ä»»ä½•æ ¼å¼ã€‚`;
                    
                    window.ST_Game_API.generate(prompt, function(response) {
                        clearTimeout(timer); // æ¸…é™¤è¶…æ—¶è®¡æ—¶å™¨

                        if (response && response !== "error") {
                            // AI å›å¤äº†ï¼Œä¸Šå±
                            const aiName = (typeof ST_CharName !== 'undefined') ? ST_CharName : "å¯¹æ–¹";
                            addLog(aiName, response.trim(), "log-ai");
                            
                            // å†æ¬¡å°è¯•è”ç½‘ä¿å­˜
                            if (window.ST_Game_API) {
                                window.ST_Game_API.save(gameHistory).catch(e=>{});
                            }
                        } else {
                            // è™½ç„¶è¿™é‡Œæ˜¾ç¤ºé”™è¯¯ï¼Œä½†ä¸Šé¢ç©å®¶çš„è®°å½•å·²ç»ä¿å­˜åœ¨æœ¬åœ°äº†ï¼Œä¸ä¼šä¸¢
                            addLog("ç³»ç»Ÿ", "å¯¹æ–¹æ‰çº¿äº†", "log-sys");
                        }
                        
                        // æ¢å¤æŒ‰é’®
                        $btn.prop('disabled', false).text("ğŸ² æ·éª°å­");
                    });
                } else {
                    // æ²¡æœ‰ API çš„æƒ…å†µ
                    setTimeout(() => {
                        addLog("ç³»ç»Ÿ", "API æœªè¿æ¥ (æœ¬åœ°æ¨¡å¼)", "log-sys");
                        $btn.prop('disabled', false).text("ğŸ² æ·éª°å­");
                    }, 500);
                }
            });
        });
    </script>
</body>
</html>
