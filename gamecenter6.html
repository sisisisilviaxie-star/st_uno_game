<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŒå±‚æ¸¸æˆä¸­å¿ƒ</title>
    <style>
        body { background-color: #1a1a1a; color: #e0e0e0; font-family: sans-serif; overflow: hidden; margin: 0; padding: 15px; user-select: none;}
        .header { display: flex; justify-content: space-between; border-bottom: 1px solid #333; padding-bottom: 10px; margin-bottom: 10px; }
        #screen-display { background: rgba(0,0,0,0.3); border: 1px solid #333; height: 150px; overflow-y: auto; padding: 10px; border-radius: 5px; white-space: pre-wrap; font-family: monospace; }
        button { width: 100%; padding: 12px; background: #667eea; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; margin-top: 10px; }
        button:disabled { background: #444; color: #888; cursor: wait; }
        .log-p { color: #4ecdc4; }
        .log-ai { color: #ff9f43; }
    </style>
</head>
<body>
    <div class="header">
        <span>ğŸ² äº’åŠ¨æ¡Œæ¸¸</span>
        <span id="player-name" style="font-size:12px; color:#aaa;">ç©å®¶</span>
    </div>
    <div id="screen-display"></div>
    <button id="dice-btn">ğŸ² æ·éª°å­</button>

    <script>
        let gameHistory = "";
        let myName = "ç©å®¶";

        $(document).ready(function() {
            // 1. åˆå§‹åŒ–
            if (typeof ST_UserName !== 'undefined') myName = ST_UserName;
            $('#player-name').text(myName);

            if (typeof ST_InitialData !== 'undefined' && ST_InitialData.trim() !== "") {
                gameHistory = ST_InitialData;
                renderHistory();
            } else {
                appendLog("ç³»ç»Ÿ", "æ¸¸æˆå¼€å§‹...", "color:#888");
                saveData();
            }

            // 2. ç‚¹å‡»äº‹ä»¶
            $('#dice-btn').click(async function() {
                const $btn = $(this);
                $btn.prop('disabled', true).text("å¯¹æ–¹æ€è€ƒä¸­...");

                // A. ç©å®¶è¡ŒåŠ¨
                const point = Math.floor(Math.random() * 6) + 1;
                appendLog(myName, `æ·å‡ºäº† ${point} ç‚¹`, "log-p");
                
                // B. ç¬¬ä¸€æ¬¡ä¿å­˜ (å­˜ç©å®¶çš„æ“ä½œ)
                await saveData();

                // C. ã€ä¿®æ­£ã€‘è°ƒç”¨é™é»˜ç”Ÿæˆè¯·æ±‚
                if (window.requestGameAI) {
                    // è¿™é‡Œçš„ Prompt ä¸ä¼šå‘åˆ°èŠå¤©æ¡†ï¼Œåªä¼šå‘ç»™åå° LLM
                    const prompt = `è¿™æ˜¯ä¸€ä¸ªæ·éª°å­æ¸¸æˆã€‚ç”¨æˆ·(${myName})æ·å‡ºäº† ${point} ç‚¹ã€‚è¯·ä½ ä»¥{{char}}çš„èº«ä»½ä¹Ÿæ·ä¸€ä¸ªéª°å­ï¼Œå¹¶ç®€çŸ­è¯„ä»·ã€‚è¯·ç›´æ¥è¾“å‡ºå†…å®¹ï¼Œä¸è¦å¸¦æ ‡ç­¾ã€‚`;
                    await window.requestGameAI(prompt);
                } else {
                    console.warn("æœªæ‰¾åˆ° requestGameAI");
                    // å¦‚æœæ²¡æ‰¾åˆ°æ¥å£ï¼Œæ‰‹åŠ¨æ¢å¤æŒ‰é’®ï¼Œå…å¾—å¡æ­»
                    $btn.prop('disabled', false).text("ğŸ² æ·éª°å­");
                }
            });
        });

        // 3. æ¥æ”¶é™é»˜ç”Ÿæˆçš„ç»“æœ
        window.handleAIResponse = async function(aiText) {
            console.log("æ”¶åˆ°é™é»˜å›å¤:", aiText);
            
            // D. è®°å½• AI è¡ŒåŠ¨
            const cleanText = aiText.trim();
            const aiName = (typeof ST_CharName !== 'undefined') ? ST_CharName : "å¯¹æ–¹";
            appendLog(aiName, cleanText, "log-ai");
            
            // E. ç¬¬äºŒæ¬¡ä¿å­˜ (æŠŠ AI çš„æ“ä½œä¹Ÿå­˜è¿›å»)
            // æ­¤æ—¶ç•Œé¢è¿˜æ˜¯é‚£ä¸€å±‚ï¼Œåªæ˜¯å†…å®¹å˜å¤šäº†
            await saveData();

            // F. æ¢å¤æŒ‰é’®
            $('#dice-btn').prop('disabled', false).text("ğŸ² æ·éª°å­");
        };

        function appendLog(name, text, cssClass) {
            const spanStyle = cssClass.includes(':') ? `style="${cssClass}"` : `class="${cssClass}"`;
            const newEntry = `<span ${spanStyle}>[${name}]</span> ${text}`;
            if (gameHistory) gameHistory += "\n";
            gameHistory += newEntry;
            renderHistory();
        }

        function renderHistory() {
            const $screen = $('#screen-display');
            $screen.html(gameHistory.replace(/\n/g, "<br>"));
            $screen.scrollTop($screen[0].scrollHeight);
        }

        async function saveData() {
            if (window.saveToCurrentLayer) {
                await window.saveToCurrentLayer(gameHistory);
            }
        }
    </script>
</body>
</html>
